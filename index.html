<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vocab Garden v8.5 - Smart Garden</title>
    
    <!-- Meta tags cho PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#10b981">
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon.png">

    <!-- Frameworks & Th∆∞ vi·ªán -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Quicksand', sans-serif;
            min-height: 100vh;
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            transition: background 1.5s ease-in-out;
        }

        /* Dynamic Backgrounds */
        body.mood-gloomy {
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        }
        body.mood-sunny {
            background: linear-gradient(135deg, #f0fdf4 0%, #e0f2fe 100%);
        }

        /* Glassmorphism UI */
        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .card-shadow {
            box-shadow: 0 10px 40px -10px rgba(31, 38, 135, 0.1);
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        .btn-gradient {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 6px 16px -4px rgba(16, 185, 129, 0.4);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); transform: scale(1); }
        }
        .animate-pulse-green { animation: pulse-green 0.4s ease-out; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }

        .nav-active {
            background: #10b981;
            color: white !important;
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
        }

        input, textarea { user-select: text; }
        .icon-container svg { display: block; }
    </style>
</head>
<body class="mood-gloomy">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const getLocalDateStr = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() - offset);
            return localDate.toISOString().split('T')[0];
        };

        // --- SMART CHECKING ALGORITHMS V2 ---
        
        // 1. T√≠nh kho·∫£ng c√°ch ch·ªânh s·ª≠a (Levenshtein)
        const levenshtein = (a, b) => {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        };

        // 2. H√†m l√†m s·∫°ch chu·ªói c∆° b·∫£n (B·ªè d·∫•u c√¢u, y->i, kho·∫£ng tr·∫Øng th·ª´a)
        const cleanString = (str) => {
            if (!str) return "";
            return str.toLowerCase()
                .replace(/[.,/#!$%^&*;:{}=\-_`~]/g, "") 
                .replace(/\s{2,}/g, " ") 
                .replace(/y/g, "i") // ƒê·ªìng nh·∫•t y v√† i
                .trim();
        };

        // 3. T·∫°o c√°c bi·∫øn th·ªÉ ƒë√°p √°n ch·∫•p nh·∫≠n ƒë∆∞·ª£c (Logic M·ªõi)
        const getVariations = (text) => {
             const variations = new Set();
             
             // Bi·∫øn th·ªÉ A: Gi·ªØ n·ªôi dung, thay ngo·∫∑c b·∫±ng kho·∫£ng tr·∫Øng (cho ph√©p nh·∫≠p full: "b√†n ch√¢n th√∫ c√≥ vu·ªët")
             const textNoBrackets = text.replace(/[()\[\]]/g, " ");
             variations.add(cleanString(textNoBrackets));

             // Bi·∫øn th·ªÉ B: B·ªè ho√†n to√†n n·ªôi dung trong ngo·∫∑c (cho ph√©p nh·∫≠p t·∫Øt: "b√†n ch√¢n")
             const textRemovedContent = text.replace(/\(.*?\)/g, "").replace(/\[.*?\]/g, "");
             variations.add(cleanString(textRemovedContent));

             return Array.from(variations).filter(v => v.length > 0);
        };

        const Icon = ({ name, size = 24, className = "", strokeWidth = 2.5 }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && window.lucide) {
                    const iconName = name.replace(/([A-Z])/g, "-$1").toLowerCase().replace(/^-/, "");
                    containerRef.current.innerHTML = `<i data-lucide="${iconName}"></i>`;
                    window.lucide.createIcons({
                        attrs: { width: size, height: size, class: className, 'stroke-width': strokeWidth },
                        nameAttr: 'data-lucide',
                        root: containerRef.current
                    });
                }
            }, [name, size, className, strokeWidth]);
            return <span ref={containerRef} className="icon-container inline-flex items-center justify-center"></span>;
        };

        const playSound = (type) => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                const now = ctx.currentTime;

                if (type === 'correct') {
                    osc.type = 'sine'; 
                    osc.frequency.setValueAtTime(523, now); 
                    osc.frequency.exponentialRampToValueAtTime(1046, now + 0.1);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.2, now + 0.05);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                } else if (type === 'wrong') {
                    osc.type = 'sawtooth'; 
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.2, now + 0.05);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                } else if (type === 'level-up') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(554, now + 0.1);
                    osc.frequency.setValueAtTime(659, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.5);
                }
                osc.start(now); osc.stop(now + 0.5);
            } catch (e) {}
        };

        const SRS_INTERVALS = [1, 3, 7, 15, 30, 60, 180, 365];
        const generateId = () => Math.random().toString(36).substring(2, 11) + Date.now().toString(36);

        const shuffleArray = (array) => {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        };

        const StreakPath = ({ history, today }) => {
            const days = 7;
            const pathData = useMemo(() => {
                const points = [];
                for (let i = 0; i < days; i++) {
                    const x = 6 + (i / (days - 1)) * 88;
                    const angle = (i / (days - 1)) * Math.PI * 2; 
                    const y = 50 + Math.sin(angle) * 25; 
                    points.push({ x, y });
                }
                return points;
            }, []);

            const svgPath = useMemo(() => {
                return pathData.reduce((acc, p, i) => {
                    if (i === 0) return `M ${p.x} ${p.y}`;
                    const prev = pathData[i-1];
                    const cp1x = prev.x + (p.x - prev.x) / 2;
                    const cp1y = prev.y;
                    const cp2x = prev.x + (p.x - prev.x) / 2;
                    const cp2y = p.y;
                    return `${acc} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p.x} ${p.y}`;
                }, "");
            }, [pathData]);

            const daysToDisplay = useMemo(() => {
                const d = [];
                for (let i = days - 1; i >= 0; i--) {
                    const cur = new Date(today);
                    cur.setDate(today.getDate() - i);
                    const dateStr = getLocalDateStr(cur);
                    d.push({ date: dateStr, count: history[dateStr] || 0, isToday: i === 0 });
                }
                return d;
            }, [history, today]);

            const getFlowerInfo = (count, isToday) => {
                if (count === 0) return { icon: isToday ? 'Loader' : 'Circle', color: 'bg-slate-200 text-slate-400', scale: 1, shadow: '' };
                if (count <= 2) return { icon: 'Sprout', color: 'bg-emerald-100 text-emerald-500', scale: 1.1, shadow: 'shadow-emerald-200' };
                if (count <= 5) return { icon: 'Flower', color: 'bg-pink-100 text-pink-500', scale: 1.25, shadow: 'shadow-pink-200' };
                return { icon: 'Sun', color: 'bg-amber-100 text-amber-500', scale: 1.4, shadow: 'shadow-amber-200' };
            };

            return (
                <div className="glass p-6 rounded-[2.5rem] card-shadow border-white/50 relative overflow-hidden min-h-[180px] group">
                    <div className="absolute top-4 left-6 z-20">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2 text-sm">
                            <Icon name="Map" size={16} className="text-emerald-600" />
                            H√†nh tr√¨nh r·ª´ng gi√†
                        </h3>
                        <div className="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-wider pl-6">
                            7 ng√†y qua
                        </div>
                    </div>
                    
                    <Icon name="Cloud" className="absolute top-4 right-10 text-white/40 float-animation" size={50} />
                    <Icon name="Cloud" className="absolute bottom-4 left-20 text-white/30 float-animation" size={30} style={{animationDelay: '1.5s'}} />

                    <div className="relative w-full h-[120px] mt-8">
                        <svg className="absolute inset-0 w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                            <path d={svgPath} fill="none" stroke="#cbd5e1" strokeWidth="1.5" strokeDasharray="6 4" strokeLinecap="round" />
                        </svg>

                        {daysToDisplay.map((day, idx) => {
                            const pos = pathData[idx];
                            const info = getFlowerInfo(day.count, day.isToday);
                            const displayDate = parseInt(day.date.split('-')[2]);
                            
                            return (
                                <div key={idx} className="absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-1 group/node z-10" style={{ left: `${pos.x}%`, top: `${pos.y}%` }}>
                                    <div className={`w-9 h-9 rounded-full flex items-center justify-center transition-all duration-700 shadow-lg border-2 border-white ${info.color} ${info.shadow}`} style={{ transform: `scale(${info.scale})` }}>
                                        <Icon name={info.icon} size={16} className={day.isToday && day.count===0 ? "animate-spin" : ""} strokeWidth={2.5} />
                                    </div>
                                    <div className={`text-[10px] font-bold ${day.isToday ? 'text-emerald-600 bg-white/80 px-1.5 rounded-full backdrop-blur-sm' : 'text-slate-400'}`}>
                                        {day.isToday ? 'Nay' : displayDate}
                                    </div>
                                    {day.count > 0 && (
                                        <div className="opacity-0 group-hover/node:opacity-100 absolute -top-8 bg-slate-800 text-white text-[9px] font-bold px-2 py-1 rounded-lg transition-opacity whitespace-nowrap z-30 pointer-events-none">
                                            {day.count} b√†i
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [vocabList, setVocabList] = useState([]);
            const [practiceHistory, setPracticeHistory] = useState({});
            const [activeTab, setActiveTab] = useState('dashboard');
            
            const [isReviewing, setIsReviewing] = useState(false);
            const [isFreePractice, setIsFreePractice] = useState(false);
            const [isLearning, setIsLearning] = useState(false);
            const [sessionQueue, setSessionQueue] = useState([]);
            const [currentWordIndex, setCurrentWordIndex] = useState(0);
            const [userAnswer, setUserAnswer] = useState('');
            const [hasChecked, setHasChecked] = useState(false);
            const [isCorrectFeedback, setIsCorrectFeedback] = useState(false);
            
            const [waterDrops, setWaterDrops] = useState(5);
            const [isGameOver, setIsGameOver] = useState(false);
            
            const [shake, setShake] = useState(false);
            const [newTerm, setNewTerm] = useState('');
            const [newIpa, setNewIpa] = useState('');
            const [newDef, setNewDef] = useState('');
            const [addMode, setAddMode] = useState('single');
            const [bulkInput, setBulkInput] = useState('');
            const [warehouseError, setWarehouseError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');

            const today = useMemo(() => {
                const d = new Date(); d.setHours(0, 0, 0, 0); return d;
            }, []);
            const todayTimestamp = today.getTime();
            const todayStr = getLocalDateStr(new Date());

            useEffect(() => {
                const savedData = localStorage.getItem('vocab_garden_data_v8');
                const savedHistory = localStorage.getItem('vocab_garden_history_v8');
                if (savedData) try { setVocabList(JSON.parse(savedData)); } catch (e) {}
                if (savedHistory) try { setPracticeHistory(JSON.parse(savedHistory)); } catch (e) {}
            }, []);

            useEffect(() => {
                localStorage.setItem('vocab_garden_data_v8', JSON.stringify(vocabList));
                localStorage.setItem('vocab_garden_history_v8', JSON.stringify(practiceHistory));
            }, [vocabList, practiceHistory]);

            useEffect(() => {
                const hasStudied = (practiceHistory[todayStr] || 0) > 0;
                document.body.className = hasStudied ? 'mood-sunny' : 'mood-gloomy';
            }, [practiceHistory, todayStr]);

            const masteredCount = useMemo(() => vocabList.filter(w => w.status === 'mastered').length, [vocabList]);
            
            const levelInfo = useMemo(() => {
                if (masteredCount < 50) return { title: "Ng∆∞·ªùi gieo h·∫°t", color: "text-slate-500", icon: "Sprout" };
                if (masteredCount <= 150) return { title: "Ng∆∞·ªùi chƒÉm ch·ªìi", color: "text-lime-600", icon: "Leaf" };
                if (masteredCount <= 500) return { title: "Ngh·ªá nh√¢n v∆∞·ªùn", color: "text-emerald-600", icon: "Flower2" };
                return { title: "B·∫≠c th·∫ßy r·ª´ng gi√†", color: "text-purple-600", icon: "Trees" };
            }, [masteredCount]);

            const getPlantIcon = useCallback((word) => {
                if (word.status === 'queue') return 'üåë';
                const nextReview = new Date(word.nextReviewDate).getTime();
                if (nextReview <= todayTimestamp && word.status !== 'mastered') return 'ü•Ä';
                if (word.status === 'mastered') return nextReview <= todayTimestamp ? 'üå≤‚ö†Ô∏è' : 'üå≤';
                if (word.streak >= 4) return 'üå≥';
                if (word.streak >= 1) return 'üåø';
                return 'üå±';
            }, [todayTimestamp]);

            const startPractice = (type) => {
                let baseQueue = [];
                if (type === 'review') {
                    baseQueue = vocabList.filter(w => 
                        (w.status === 'learning' || w.status === 'mastered') && 
                        new Date(w.nextReviewDate).getTime() <= todayTimestamp
                    );
                } else if (type === 'free') {
                    baseQueue = vocabList.filter(w => w.status === 'learning');
                }
                
                if (baseQueue.length > 0) {
                    const preparedQueue = shuffleArray(baseQueue).map(word => ({
                        ...word,
                        testType: Math.random() > 0.5 ? 'en-vi' : 'vi-en'
                    }));
                    setSessionQueue(preparedQueue);
                    setIsFreePractice(type === 'free');
                    setIsReviewing(true);
                    setCurrentWordIndex(0);
                    setUserAnswer('');
                    setHasChecked(false);
                    setWaterDrops(5);
                    setIsGameOver(false);
                }
            };

            const checkAnswer = () => {
                if (hasChecked || isGameOver) return;
                const currentWord = sessionQueue[currentWordIndex];
                
                // Chu·∫©n h√≥a input ng∆∞·ªùi d√πng (ch·ªâ b·ªè d·∫•u c√¢u th·ª´a, y->i, kh√¥ng b·ªè ch·ªØ)
                const userNorm = cleanString(userAnswer);
                
                let isCorrect = false;

                // L·∫•y danh s√°ch c√°c ƒë√°p √°n g·ªëc (t√°ch b·ªüi d·∫•u ph·∫©y...)
                let rawAnswers = [];
                if (currentWord.testType === 'en-vi') {
                    rawAnswers = currentWord.definition.split(/[,;|\/]/);
                } else {
                    rawAnswers = [currentWord.term];
                }

                // T·∫°o danh s√°ch T·∫§T C·∫¢ c√°c bi·∫øn th·ªÉ ch·∫•p nh·∫≠n ƒë∆∞·ª£c
                let acceptableAnswers = [];
                rawAnswers.forEach(raw => {
                    acceptableAnswers.push(...getVariations(raw));
                });

                // So kh·ªõp
                isCorrect = acceptableAnswers.some(ans => {
                    if (ans === userNorm) return true; // Kh·ªõp ch√≠nh x√°c
                    // Kh·ªõp m·ªù (Fuzzy)
                    const dist = levenshtein(ans, userNorm);
                    const allowedErrors = ans.length > 8 ? 2 : (ans.length > 3 ? 1 : 0);
                    return dist <= allowedErrors;
                });
                
                setIsCorrectFeedback(isCorrect);
                setHasChecked(true);
                playSound(isCorrect ? 'correct' : 'wrong');

                if (!isCorrect) {
                    setShake(true); 
                    setTimeout(() => setShake(false), 500);
                    const newWater = waterDrops - 1;
                    setWaterDrops(newWater);
                    if (newWater <= 0) setIsGameOver(true);
                } else {
                    confetti({
                        particleCount: 40,
                        spread: 50,
                        origin: { y: 0.8 },
                        colors: ['#10b981', '#34d399', '#ffffff']
                    });
                }
            };

            const handleNext = () => {
                if (isGameOver) {
                    setIsReviewing(false);
                    return;
                }

                const currentWord = sessionQueue[currentWordIndex];
                setVocabList(prev => prev.map(word => {
                    if (word.id === currentWord.id) {
                        if (word.status === 'mastered') {
                            if (isCorrectFeedback) {
                                const tomorrow = new Date();
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                tomorrow.setHours(0, 0, 0, 0);
                                return { ...word, nextReviewDate: tomorrow.toISOString() };
                            } else {
                                return { ...word, status: 'learning', streak: 0, nextReviewDate: new Date().toISOString() };
                            }
                        }
                        let newStreak = isCorrectFeedback ? word.streak + 1 : 0;
                        if (newStreak >= 7 && word.status !== 'mastered') {
                             playSound('level-up');
                             confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });
                        }
                        let daysToAdd = isCorrectFeedback ? (SRS_INTERVALS[newStreak] || 365) : 1;
                        const nextDate = new Date();
                        nextDate.setDate(nextDate.getDate() + daysToAdd);
                        nextDate.setHours(0, 0, 0, 0);
                        return { ...word, streak: newStreak, nextReviewDate: nextDate.toISOString(), status: newStreak >= 7 ? 'mastered' : 'learning' };
                    }
                    return word;
                }));

                if (currentWordIndex < sessionQueue.length - 1) {
                    setCurrentWordIndex(prev => prev + 1);
                    setHasChecked(false);
                    setUserAnswer('');
                } else {
                    confetti({ particleCount: 200, spread: 160 });
                    const currentLocalStr = getLocalDateStr(new Date());
                    setPracticeHistory(prev => ({ ...prev, [currentLocalStr]: (prev[currentLocalStr] || 0) + 1 }));
                    setIsReviewing(false);
                    setActiveTab('dashboard');
                }
            };

            const addNewWord = (e) => {
                e.preventDefault();
                const term = newTerm.trim();
                const def = newDef.trim();
                if (!term || !def) return;
                if (vocabList.some(w => w.term.toLowerCase() === term.toLowerCase())) {
                    setWarehouseError(`T·ª´ "${term}" ƒë√£ c√≥ trong kho!`);
                    setShake(true);
                    setTimeout(() => { setShake(false); setWarehouseError(''); }, 3000);
                    return;
                }
                setVocabList(prev => [...prev, { id: generateId(), term, ipa: newIpa.trim(), definition: def, dateAdded: new Date().toISOString(), nextReviewDate: new Date().toISOString(), streak: 0, status: 'queue' }]);
                setNewTerm(''); setNewIpa(''); setNewDef('');
                document.getElementById('term-input')?.focus();
            };

            const handleWarehouseKeyDown = (e, field) => {
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    if (field === 'term') { e.preventDefault(); if (e.key === 'ArrowDown') document.getElementById('def-input')?.focus(); else document.getElementById('ipa-input')?.focus(); }
                    else if (field === 'ipa') { e.preventDefault(); document.getElementById('def-input')?.focus(); }
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    if (field === 'ipa') { e.preventDefault(); document.getElementById('term-input')?.focus(); }
                    else if (field === 'def') { e.preventDefault(); if (e.key === 'ArrowUp') document.getElementById('term-input')?.focus(); else document.getElementById('ipa-input')?.focus(); }
                }
            };

            const exportData = () => {
                const data = JSON.stringify({ vocabList, practiceHistory });
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `garden_backup_v8.json`;
                a.click();
            };

            const filteredList = useMemo(() => {
                return vocabList.filter(w => {
                    const matchesSearch = w.term.toLowerCase().includes(searchTerm.toLowerCase()) || w.definition.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesFilter = filterStatus === 'all' || w.status === filterStatus;
                    return matchesSearch && matchesFilter;
                }).reverse();
            }, [vocabList, searchTerm, filterStatus]);

            useEffect(() => {
                const handleGlobalKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        if (isReviewing) {
                            e.preventDefault();
                            if (!hasChecked) { if (userAnswer.trim()) checkAnswer(); }
                            else { handleNext(); }
                        } else if (isLearning) {
                             const wordToLearn = vocabList.filter(w => w.status === 'queue').slice(0, 5)[currentWordIndex];
                             if (wordToLearn) { e.preventDefault(); document.getElementById('btn-learn-next')?.click(); }
                        }
                    }
                };
                window.addEventListener('keydown', handleGlobalKeyDown);
                return () => window.removeEventListener('keydown', handleGlobalKeyDown);
            }, [isReviewing, hasChecked, userAnswer, sessionQueue, currentWordIndex, isLearning, vocabList]);

            return (
                <div className="max-w-2xl mx-auto px-4 pb-32 pt-6 safe-pt">
                    <header className="glass rounded-[2.5rem] p-6 mb-8 card-shadow flex items-center justify-between border-white/50">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 btn-gradient rounded-2xl flex items-center justify-center float-animation">
                                <Icon name={levelInfo.icon} className="text-white" size={28} />
                            </div>
                            <div>
                                <h1 className="text-xl font-black text-slate-800 tracking-tight leading-none uppercase">Garden</h1>
                                <p className={`text-[11px] font-bold uppercase tracking-widest mt-1.5 ${levelInfo.color}`}>{levelInfo.title}</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                             <button onClick={exportData} className="w-10 h-10 rounded-xl glass flex items-center justify-center text-slate-400 hover:text-emerald-500 transition-all active:scale-90">
                                <Icon name="DownloadCloud" size={20} />
                            </button>
                        </div>
                    </header>

                    {activeTab === 'dashboard' ? (
                        <div className="space-y-8 animate-in fade-in duration-700">
                            <StreakPath history={practiceHistory} today={today} />
                            
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={() => startPractice('review')} disabled={vocabList.filter(w => (w.status === 'learning' || w.status === 'mastered') && new Date(w.nextReviewDate).getTime() <= todayTimestamp).length === 0}
                                    className="glass card-shadow p-6 rounded-[2.5rem] flex flex-col items-center gap-3 active:scale-95 transition-all disabled:opacity-30 border-white/40 group">
                                    <div className="w-14 h-14 bg-amber-100 text-amber-600 rounded-[1.25rem] flex items-center justify-center group-hover:rotate-12 transition-transform">
                                        <Icon name="Droplets" size={32} />
                                    </div>
                                    <div className="text-center">
                                        <span className="block font-bold text-slate-700">T∆∞·ªõi n∆∞·ªõc</span>
                                        <span className="text-[10px] font-bold text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full uppercase tracking-tighter">
                                            {vocabList.filter(w => (w.status === 'learning' || w.status === 'mastered') && new Date(w.nextReviewDate).getTime() <= todayTimestamp).length} c√¢y kh√¥
                                        </span>
                                    </div>
                                </button>
                                <button onClick={() => setIsLearning(true)} disabled={vocabList.filter(w => w.status === 'queue').length === 0}
                                    className="glass card-shadow p-6 rounded-[2.5rem] flex flex-col items-center gap-3 active:scale-95 transition-all disabled:opacity-30 border-white/40 group">
                                    <div className="w-14 h-14 bg-emerald-100 text-emerald-600 rounded-[1.25rem] flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <Icon name="Sprout" size={32} />
                                    </div>
                                    <div className="text-center">
                                        <span className="block font-bold text-slate-700">Gieo h·∫°t</span>
                                        <span className="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full uppercase tracking-tighter">
                                            {vocabList.filter(w => w.status === 'queue').length} h·∫°t s·∫µn
                                        </span>
                                    </div>
                                </button>
                            </div>

                            <button onClick={() => startPractice('free')} disabled={vocabList.filter(w => w.status === 'learning').length === 0}
                                className="w-full glass card-shadow p-5 rounded-[2rem] flex items-center justify-center gap-3 active:scale-95 transition-all border-white/30 disabled:opacity-40">
                                <Icon name="Zap" size={20} className="text-blue-500" />
                                <span className="font-bold text-slate-600 text-sm uppercase tracking-wide">Luy·ªán t·∫≠p t·ª± do ({vocabList.filter(w => w.status === 'learning').length})</span>
                            </button>

                            <div className="glass card-shadow rounded-[2.5rem] p-8 border-white/50">
                                <div className="flex items-center justify-between mb-8">
                                    <h3 className="font-extrabold text-slate-800 text-lg flex items-center gap-3">
                                        <Icon name="Trees" className="text-emerald-500" /> Khu v∆∞·ªùn
                                    </h3>
                                    <div className="flex gap-4">
                                        <div className="text-center">
                                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-tighter leading-none mb-1">T·ªïng t·ª´</p>
                                            <p className="text-lg font-black text-slate-700 leading-none">{vocabList.length}</p>
                                        </div>
                                        <div className="text-center">
                                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-tighter leading-none mb-1">C·ªï th·ª•</p>
                                            <p className="text-lg font-black text-purple-600 leading-none">{masteredCount}</p>
                                        </div>
                                    </div>
                                </div>
                                {vocabList.length === 0 ? (
                                    <div className="py-16 text-center text-slate-400 italic text-sm">V∆∞·ªùn r·ªóng, h√£y th√™m h·∫°t gi·ªëng!</div>
                                ) : (
                                    <div className="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-3">
                                        {vocabList.map(word => (
                                            <div key={word.id} className="aspect-square glass rounded-[1.25rem] flex items-center justify-center text-2xl hover:scale-125 transition-all cursor-help border-white/60 shadow-sm" title={word.term}>
                                                {getPlantIcon(word)}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                            <div className={`glass rounded-[2.5rem] p-7 card-shadow transition-all border-white/60 ${shake ? 'animate-shake border-red-300' : ''}`}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                        <Icon name="PlusCircle" className="text-emerald-600" size={20} /> Th√™m h·∫°t m·ªõi
                                    </h3>
                                    <button onClick={() => setAddMode(addMode === 'single' ? 'bulk' : 'single')} className="text-[10px] font-black uppercase text-emerald-600 bg-emerald-50 px-4 py-2 rounded-full border border-emerald-100">
                                        {addMode === 'single' ? 'D√πng Trang t√≠nh' : 'Nh·∫≠p ƒë∆°n'}
                                    </button>
                                </div>

                                {addMode === 'single' ? (
                                    <form onSubmit={addNewWord} className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <input id="term-input" value={newTerm} onChange={e => {setNewTerm(e.target.value); setWarehouseError('');}} onKeyDown={e => handleWarehouseKeyDown(e, 'term')} className="w-full p-4 bg-white/60 rounded-2xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 font-bold text-slate-700 transition-all" placeholder="Ti·∫øng Anh..." />
                                                {warehouseError && <p className="text-[10px] text-red-500 font-bold ml-2 italic">{warehouseError}</p>}
                                            </div>
                                            <input id="ipa-input" value={newIpa} onChange={e => setNewIpa(e.target.value)} onKeyDown={e => handleWarehouseKeyDown(e, 'ipa')} className="w-full p-4 bg-white/60 rounded-2xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 font-mono text-emerald-600 transition-all" placeholder="IPA..." />
                                        </div>
                                        <input id="def-input" value={newDef} onChange={e => setNewDef(e.target.value)} onKeyDown={e => handleWarehouseKeyDown(e, 'def')} className="w-full p-4 bg-white/60 rounded-2xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 font-bold text-slate-700 transition-all" placeholder="Nghƒ©a ti·∫øng Vi·ªát..." />
                                        <button type="submit" className="w-full btn-gradient text-white p-5 rounded-2xl font-black uppercase tracking-widest active:scale-95 transition-all shadow-xl">L∆∞u v√†o kho</button>
                                    </form>
                                ) : (
                                    <div className="space-y-4 animate-in fade-in">
                                        <p className="text-[11px] text-slate-400 italic bg-white/50 p-4 rounded-2xl border border-dashed border-emerald-200">D√°n d·ªØ li·ªáu 3 c·ªôt (Anh - IPA - Vi·ªát) t·ª´ Excel/Sheets v√†o ƒë√¢y.</p>
                                        <textarea value={bulkInput} onChange={e => setBulkInput(e.target.value)} rows="6" className="w-full p-4 bg-white/60 rounded-2xl outline-none border-2 border-dashed border-slate-200 focus:border-emerald-500 transition-all" placeholder="English	/ipa/	Vietnamese..."></textarea>
                                        <button onClick={() => {
                                            const lines = bulkInput.split('\n').filter(l => l.trim());
                                            const added = [];
                                            lines.forEach(line => {
                                                const parts = line.split('\t');
                                                const term = parts[0]?.trim();
                                                const ipa = parts.length === 3 ? parts[1]?.trim() : '';
                                                const def = parts.length === 3 ? parts[2]?.trim() : parts[1]?.trim();
                                                if (term && def && !vocabList.find(w => w.term.toLowerCase() === term.toLowerCase())) {
                                                    added.push({ id: generateId(), term, ipa, definition: def, dateAdded: new Date().toISOString(), nextReviewDate: new Date().toISOString(), streak: 0, status: 'queue' });
                                                }
                                            });
                                            setVocabList(prev => [...prev, ...added]); setBulkInput(''); setAddMode('single');
                                        }} className="w-full btn-gradient text-white p-5 rounded-2xl font-black uppercase tracking-widest shadow-xl">Nh·∫≠p h√†ng lo·∫°t</button>
                                    </div>
                                )}
                            </div>

                            <div className="glass rounded-[2.5rem] p-7 card-shadow border-white/60 min-h-[500px]">
                                <div className="flex gap-2 mb-6 overflow-x-auto pb-3 no-scrollbar">
                                    {[{id:'all',l:'T·∫•t c·∫£'},{id:'queue',l:'H·∫°t gi·ªëng'},{id:'learning',l:'ƒêang l·ªõn'},{id:'mastered',l:'C·ªï th·ª•'}].map(f => (
                                        <button key={f.id} onClick={() => setFilterStatus(f.id)} className={`px-5 py-2.5 rounded-full text-[11px] font-black uppercase whitespace-nowrap transition-all ${filterStatus === f.id ? 'nav-active' : 'bg-white/50 text-slate-400 hover:text-emerald-500'}`}>{f.l}</button>
                                    ))}
                                </div>
                                <div className="relative mb-6">
                                    <Icon name="Search" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
                                    <input value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-12 pr-4 py-4 bg-white/50 rounded-2xl outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 font-medium transition-all shadow-inner" placeholder="T√¨m ki·∫øm t·ª´ v·ª±ng..." />
                                </div>
                                <div className="space-y-3 max-h-[550px] overflow-y-auto pr-2 no-scrollbar">
                                    {filteredList.map(w => (
                                        <div key={w.id} className="flex items-center justify-between p-4 glass rounded-[1.5rem] group hover:border-emerald-300 transition-all card-shadow">
                                            <div className="flex items-center gap-4">
                                                <span className="text-2xl drop-shadow-sm">{getPlantIcon(w)}</span>
                                                <div>
                                                    <p className="font-bold text-slate-800 text-sm">{w.term} <span className="text-xs font-mono text-emerald-500 ml-1">/{w.ipa}/</span></p>
                                                    <p className="text-xs text-slate-500 font-medium">{w.definition}</p>
                                                </div>
                                            </div>
                                            <button onClick={() => setVocabList(vocabList.filter(x => x.id !== w.id))} className="w-9 h-9 rounded-xl text-slate-300 hover:text-red-500 hover:bg-red-50 transition-all flex items-center justify-center">
                                                <Icon name="Trash2" size={18} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {isReviewing && sessionQueue[currentWordIndex] && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-md animate-in fade-in" onClick={() => setIsReviewing(false)}></div>
                            <div className={`relative w-full max-w-md glass rounded-[3.5rem] overflow-hidden card-shadow animate-in zoom-in-95 duration-300 ${shake ? 'animate-shake' : ''}`}>
                                
                                <div className="absolute top-6 left-8 flex gap-1 z-20">
                                    {[...Array(5)].map((_, i) => (
                                        <span key={i} className={`text-sm transition-all duration-500 ${i < waterDrops ? 'opacity-100 scale-100' : 'opacity-30 grayscale scale-75'}`}>üíß</span>
                                    ))}
                                </div>

                                <div className={`p-12 text-center text-white relative transition-colors duration-500 ${hasChecked ? (isCorrectFeedback ? 'bg-emerald-500' : 'bg-rose-500') : (isFreePractice ? 'bg-blue-500' : 'bg-amber-500')}`}>
                                    <button onClick={() => setIsReviewing(false)} className="absolute top-6 right-6 w-10 h-10 rounded-full bg-black/10 flex items-center justify-center hover:bg-black/20 transition-all"><Icon name="X" size={20} /></button>
                                    <div className="text-8xl mb-8 float-animation mt-4">
                                        {hasChecked ? (isCorrectFeedback ? '‚ú®' : '‚ùå') : (isFreePractice ? '‚ö°' : 'ü•Ä')}
                                    </div>
                                    <p className="text-[10px] font-black uppercase tracking-[0.2em] opacity-70 mb-4">{sessionQueue[currentWordIndex].testType === 'en-vi' ? 'Ti·∫øng Anh' : 'Ti·∫øng Vi·ªát'}</p>
                                    <h2 className="text-4xl font-black mb-2 drop-shadow-md">
                                        {sessionQueue[currentWordIndex].testType === 'en-vi' ? sessionQueue[currentWordIndex].term : sessionQueue[currentWordIndex].definition}
                                    </h2>
                                    {sessionQueue[currentWordIndex].testType === 'en-vi' && sessionQueue[currentWordIndex].ipa && <p className="font-mono text-lg opacity-80 italic">/{sessionQueue[currentWordIndex].ipa}/</p>}
                                    <div className="mt-10 w-full bg-black/10 h-2.5 rounded-full overflow-hidden">
                                        <div className="bg-white h-full transition-all duration-700 ease-out" style={{ width: `${((currentWordIndex + 1) / sessionQueue.length) * 100}%` }}></div>
                                    </div>
                                </div>
                                <div className="p-10 space-y-8 bg-white/40">
                                    {isGameOver ? (
                                        <div className="text-center animate-in zoom-in">
                                            <h3 className="text-2xl font-black text-slate-800 mb-2">C·∫°n n∆∞·ªõc r·ªìi! ü•Ä</h3>
                                            <p className="text-slate-500 text-sm mb-6">C√¢y c·ªëi c·∫ßn ngh·ªâ ng∆°i. H√£y th·ª≠ l·∫°i sau nh√©.</p>
                                            <button onClick={() => setIsReviewing(false)} className="w-full bg-slate-800 text-white p-6 rounded-[2rem] font-black uppercase tracking-widest shadow-xl">K·∫øt th√∫c</button>
                                        </div>
                                    ) : !hasChecked ? (
                                        <div className="space-y-5">
                                            <input autoFocus type="text" value={userAnswer} onChange={e => setUserAnswer(e.target.value)} className="w-full p-6 glass border-2 border-slate-100 rounded-[2rem] outline-none focus:border-emerald-500 font-bold text-center text-2xl text-slate-700 card-shadow transition-all" placeholder="..." />
                                            <button onClick={checkAnswer} disabled={!userAnswer.trim()} className="w-full btn-gradient text-white p-6 rounded-[2rem] font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all animate-pulse-green">Ki·ªÉm tra</button>
                                        </div>
                                    ) : (
                                        <div className="space-y-10 animate-in slide-in-from-bottom-6 duration-500 text-center">
                                            <div>
                                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3">K·∫øt qu·∫£ ƒë√∫ng</p>
                                                <p className="text-3xl font-black text-slate-800 leading-tight">
                                                    {sessionQueue[currentWordIndex].testType === 'en-vi' ? sessionQueue[currentWordIndex].definition : sessionQueue[currentWordIndex].term}
                                                </p>
                                                {sessionQueue[currentWordIndex].ipa && (
                                                    <p className="text-xl font-mono text-emerald-600 mt-4 font-bold italic drop-shadow-sm">/{sessionQueue[currentWordIndex].ipa}/</p>
                                                )}
                                            </div>
                                            <button onClick={handleNext} className="w-full btn-gradient text-white p-6 rounded-[2rem] font-black uppercase tracking-widest shadow-xl active:scale-95 flex items-center justify-center gap-3 transition-all">
                                                Ti·∫øp theo <Icon name="ArrowRight" size={24} />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {isLearning && vocabList.filter(w => w.status === 'queue').slice(0, 5)[currentWordIndex] && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-md" onClick={() => setIsLearning(false)}></div>
                            <div className={`relative w-full max-w-md glass rounded-[3.5rem] overflow-hidden card-shadow animate-in zoom-in-95`}>
                                <div className="bg-emerald-500 p-12 text-center text-white relative">
                                    <button onClick={() => setIsLearning(false)} className="absolute top-8 right-8 w-10 h-10 rounded-full bg-black/10 flex items-center justify-center"><Icon name="X" size={20} /></button>
                                    <div className="text-8xl mb-8 float-animation">üå±</div>
                                    <h2 className="text-4xl font-black uppercase tracking-tight mb-2 drop-shadow-md">{vocabList.filter(w => w.status === 'queue').slice(0, 5)[currentWordIndex].term}</h2>
                                    <p className="text-lg font-mono opacity-80 italic">/{vocabList.filter(w => w.status === 'queue').slice(0, 5)[currentWordIndex].ipa}/</p>
                                </div>
                                <div className="p-12 text-center space-y-10">
                                    <div>
                                        <p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-3">√ù nghƒ©a</p>
                                        <p className="text-3xl font-black text-slate-800 leading-tight">{vocabList.filter(w => w.status === 'queue').slice(0, 5)[currentWordIndex].definition}</p>
                                    </div>
                                    <button id="btn-learn-next" onClick={() => {
                                        playSound('correct');
                                        const currentWord = vocabList.filter(w => w.status === 'queue').slice(0, 5)[currentWordIndex];
                                        setVocabList(prev => prev.map(w => w.id === currentWord.id ? { ...w, status: 'learning', nextReviewDate: new Date(Date.now() + 86400000).toISOString() } : w));
                                        if (currentWordIndex < Math.min(vocabList.filter(w => w.status === 'queue').length, 5) - 1) {
                                            setCurrentWordIndex(prev => prev + 1);
                                        } else {
                                            setIsLearning(false); setCurrentWordIndex(0);
                                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                                        }
                                    }} className="w-full btn-gradient text-white p-6 rounded-[2rem] font-black text-xl shadow-xl active:scale-95 flex items-center justify-center gap-3 transition-all">
                                        ƒê√£ thu·ªôc <Icon name="Check" size={24} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 glass rounded-full p-2.5 flex items-center gap-2 z-40 card-shadow border-white/50">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex items-center gap-2 px-8 py-4 rounded-full transition-all font-black text-xs uppercase tracking-widest ${activeTab === 'dashboard' ? 'nav-active' : 'text-slate-400 hover:text-emerald-500'}`}>
                            <Icon name="Layout" size={18} /> <span>V∆∞·ªùn</span>
                        </button>
                        <button onClick={() => setActiveTab('warehouse')} className={`flex items-center gap-2 px-8 py-4 rounded-full transition-all font-black text-xs uppercase tracking-widest ${activeTab === 'warehouse' ? 'nav-active' : 'text-slate-400 hover:text-emerald-500'}`}>
                            <Icon name="Book" size={18} /> <span>Kho</span>
                        </button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>